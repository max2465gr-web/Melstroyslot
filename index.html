<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Melstroy Slot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap');

        :root {
            --bg-dark: #051e3e;
            --bg-light: #1e5799;
            --neon-blue: #00f2ff;
            --neon-pink: #ff00de;
            --gold-light: #fceabb;
            --gold-dark: #f8b500;
            --gold-shadow: #b06602;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* –ó–í–ï–ó–î–´ –ò –§–û–ù */
        .star {
            position: absolute;
            color: #ffd700;
            font-size: 20px;
            animation: twinkle 3s infinite ease-in-out;
            opacity: 0.8;
            z-index: 0;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* –í–´–í–ï–°–ö–ê */
        .neon-sign {
            font-size: 36px;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.1;
            text-shadow: 0 0 10px #fff, 0 0 20px var(--neon-pink), 0 0 40px var(--neon-pink);
            z-index: 2;
            position: relative;
        }

        /* –ò–ì–†–û–í–ê–Ø –û–ë–õ–ê–°–¢–¨ */
        .machine-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(1);
            transition: transform 0.3s;
            z-index: 2;
        }

        .slot-machine {
            width: 340px;
            height: 380px; /* –£–≤–µ–ª–∏—á–∏–ª –≤—ã—Å–æ—Ç—É –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç—ã */
            background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold-light) 50%, var(--gold-dark) 100%);
            border-radius: 30px;
            padding: 15px;
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.5), 0 20px 50px rgba(0,0,0,0.6), 0 0 0 5px var(--gold-shadow);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .screen-border {
            width: 100%;
            height: 160px;
            background: #2a1f08;
            border-radius: 15px;
            padding: 8px;
            box-shadow: inset 0 0 15px #000;
            display: flex;
            justify-content: center;
        }

        .reels-container {
            width: 100%;
            height: 100%;
            background: #fff;
            border-radius: 10px;
            display: flex;
            overflow: hidden;
            border: 2px solid #000;
            position: relative;
        }

        .payline {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 0, 0, 0.5);
            transform: translateY(-50%);
            z-index: 5;
            box-shadow: 0 0 10px red;
            display: none;
        }

        .reel { flex: 1; border-right: 2px solid #ccc; position: relative; }
        .reel:last-child { border-right: none; }
        .reel-strip { position: absolute; top: 0; left: 0; width: 100%; }

        .symbol {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 45px;
        }
        .blur { filter: blur(3px); }

        /* –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .controls-panel {
            margin-top: 15px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .balance-box {
            background: #000;
            border: 2px solid var(--gold-light);
            border-radius: 10px;
            padding: 5px;
            color: #0f0;
            font-size: 18px;
            font-weight: 900;
            text-align: center;
            text-transform: uppercase;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.2);
        }

        .bet-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            padding: 5px;
            border: 1px solid var(--gold-shadow);
        }

        .bet-input-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
        }

        .bet-label { color: var(--gold-light); font-size: 12px; font-weight: bold; }

        /* Input type="text" –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∑–∞–ø—è—Ç—ã–º–∏ */
        #betInput {
            width: 90px;
            background: #000;
            border: 1px solid var(--gold-light);
            color: #fff;
            padding: 5px;
            border-radius: 5px;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            font-size: 14px;
        }

        .bet-buttons { display: flex; gap: 3px; }
        .bet-btn {
            background: linear-gradient(to bottom, #fceabb, #f8b500);
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 10px;
            font-weight: bold;
            color: #5a3e08;
            cursor: pointer;
        }
        .bet-btn:active { transform: translateY(1px); }

        /* –ö–ù–û–ü–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò */
        .stats-btn {
            background: linear-gradient(to right, #2b5876, #4e4376);
            border: 2px solid #fff;
            color: #fff;
            padding: 10px;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .stats-btn:active { transform: scale(0.95); }

        /* –†–´–ß–ê–ì */
        .lever-container { position: absolute; right: -30px; top: 50px; width: 60px; height: 200px; z-index: 1; }
        .lever-handle { position: absolute; left: 10px; top: 110px; width: 20px; height: 120px; transform-origin: bottom center; transform: rotate(0deg); }
        .lever-stick { width: 15px; height: 100%; background: linear-gradient(90deg, #e6b853, #fff, #b58928); border-radius: 10px; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); }
        .lever-stick::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 25px; height: 25px; background: #b58928; border-radius: 50%; }
        .lever-knob { width: 60px; height: 60px; background: radial-gradient(circle at 30% 30%, #ff5e5e, #d92e2e); border-radius: 50%; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); cursor: grab; z-index: 10; }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–°–¢–ê–¢–ò–°–¢–ò–ö–ê) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: linear-gradient(135deg, #1e2a3a, #0d121b);
            width: 90%;
            max-width: 400px;
            height: 80%;
            border-radius: 20px;
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .modal-header {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .modal-title { color: #fff; font-size: 20px; text-transform: uppercase; }
        .close-btn { position: absolute; top: 10px; right: 15px; color: #fff; font-size: 24px; cursor: pointer; }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { display: flex; background: rgba(0,0,0,0.3); }
        .tab { flex: 1; padding: 12px; text-align: center; color: #888; cursor: pointer; font-size: 14px; font-weight: bold; border-bottom: 2px solid transparent; }
        .tab.active { color: var(--neon-blue); border-bottom: 2px solid var(--neon-blue); background: rgba(0, 242, 255, 0.05); }

        /* –°–ø–∏—Å–æ–∫ –ª–∏–¥–µ—Ä–æ–≤ */
        .leaderboard-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .lb-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
            padding: 10px 15px;
            border-radius: 10px;
            color: #fff;
        }
        .lb-row.is-me {
            border: 1px solid var(--gold-dark);
            background: rgba(248, 181, 0, 0.15);
        }
        .lb-rank { width: 30px; font-size: 16px; color: #888; font-weight: bold; }
        .lb-rank.top-1 { color: #ffd700; }
        .lb-rank.top-2 { color: #c0c0c0; }
        .lb-rank.top-3 { color: #cd7f32; }

        .lb-name { flex: 1; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
        .lb-score { font-family: 'Montserrat', monospace; color: var(--neon-blue); font-weight: bold; font-size: 14px; }
        .lb-score.gold { color: #ffd700; }

        #status {
            position: fixed; bottom: 20px; font-size: 20px; color: #fff; text-shadow: 0 2px 4px #000;
            z-index: 10; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; text-align: center;
        }
        @media (max-width: 450px) { .machine-wrapper { transform: scale(0.9); } .neon-sign { font-size: 30px; } }
    </style>
</head>
<body>

    <div class="star" style="top: 10%; left: 10%;">‚òÖ</div>
    <div class="star" style="top: 20%; right: 15%; animation-delay: 1s;">‚òÖ</div>
    <div class="star" style="top: 80%; left: 20%; animation-delay: 0.5s;">‚òÖ</div>

    <div class="neon-sign">MELSTROY<br>SLOT</div>

    <div class="machine-wrapper">
        <div class="slot-machine">
            <div class="screen-border">
                <div class="reels-container">
                    <div class="payline"></div>
                    <div class="glass-overlay"></div>
                    <div class="reel"><div class="reel-strip" id="reel1"></div></div>
                    <div class="reel"><div class="reel-strip" id="reel2"></div></div>
                    <div class="reel"><div class="reel-strip" id="reel3"></div></div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="balance-box">
                    –ë–ê–õ–ê–ù–°: <span id="balance">...</span>
                </div>

                <!-- –°—Ç–∞–≤–∫–∞ —Å –∑–∞–ø—è—Ç—ã–º–∏ -->
                <div class="bet-controls">
                    <div class="bet-input-wrapper">
                        <span class="bet-label">–°–¢–ê–í–ö–ê:</span>
                        <input type="text" id="betInput" inputmode="numeric" value="50">
                    </div>
                    <div class="bet-buttons">
                        <button class="bet-btn" onclick="adjustBet('min')">MIN</button>
                        <button class="bet-btn" onclick="adjustBet('half')">/2</button>
                        <button class="bet-btn" onclick="adjustBet('double')">x2</button>
                        <button class="bet-btn" onclick="adjustBet('max')">MAX</button>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
                <button class="stats-btn" onclick="openStats()">
                    üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í
                </button>
            </div>
        </div>

        <div class="lever-container">
            <div class="lever-handle" id="leverHandle">
                <div class="lever-stick"></div>
                <div class="lever-knob" id="leverKnob"></div>
            </div>
        </div>
    </div>

    <div id="status">–ó–ê–ì–†–£–ó–ö–ê...</div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeStats()">&times;</div>
            <div class="modal-header">
                <div class="modal-title">–ó–∞–ª –°–ª–∞–≤—ã</div>
            </div>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('balance')" id="tabBalance">üí∞ –ë–æ–≥–∞—á–∏</div>
                <div class="tab" onclick="switchTab('wins')" id="tabWins">üé∞ –ó–∞–Ω–æ—Å—ã</div>
            </div>
            <div class="leaderboard-list" id="lbList">
                <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Å—Ç—Ä–æ–∫–∏ -->
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SYMBOLS = ['üíé', '7Ô∏è‚É£', 'üîî', 'üçí', 'üçã', 'üí∞'];
        const SYMBOL_HEIGHT = 80;
        const MULTIPLIERS = { 'üíé': 20, '7Ô∏è‚É£': 10, 'üí∞': 6, 'üîî': 3, 'üçã': 1.5, 'üçí': 0.5 };

        const reels = [ document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3') ];
        const balanceEl = document.getElementById('balance');
        const betInput = document.getElementById('betInput');
        const statusEl = document.getElementById('status');
        const payline = document.querySelector('.payline');
        const leverHandle = document.getElementById('leverHandle');
        const leverKnob = document.getElementById('leverKnob');
        const lbList = document.getElementById('lbList');

        let balance = 1000;
        let maxWin = 0; // –î–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        let isSpinning = false;
        let currentTab = 'balance';

        // –ê—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let spinInterval = null;
        let noiseBuffer = null;

        // --- –§–£–ù–ö–¶–ò–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ---
        // 12345 -> "12,345"
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // "12,345" -> 12345
        function parseNumber(str) {
            return parseInt(str.replace(/,/g, '')) || 0;
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–ê–í–ö–û–ô ---
        betInput.addEventListener('input', function(e) {
            // –£–¥–∞–ª—è–µ–º –≤—Å—ë –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
            let rawValue = this.value.replace(/\D/g, '');
            if (rawValue === '') rawValue = '0';

            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –±–∞–ª–∞–Ω—Å—É "–Ω–∞ –ª–µ—Ç—É" (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            let numValue = parseInt(rawValue);
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –≤–≤–µ—Å—Ç–∏ –±–æ–ª—å—à–µ –±–∞–ª–∞–Ω—Å–∞ —Å—Ä–∞–∑—É:
            // if (numValue > balance && balance > 0) numValue = balance;

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ —Å –∑–∞–ø—è—Ç—ã–º–∏
            this.value = formatNumber(numValue);
        });

        betInput.addEventListener('change', function() {
            let val = parseNumber(this.value);
            if(val < 10) val = 10;
            if(val > balance) val = balance;
            this.value = formatNumber(val);
        });

        function adjustBet(action) {
            let currentBet = parseNumber(betInput.value) || 10;
            if(action === 'min') currentBet = 10;
            if(action === 'max') currentBet = balance > 0 ? balance : 10;
            if(action === 'double') currentBet *= 2;
            if(action === 'half') currentBet = Math.floor(currentBet / 2);

            if(currentBet < 10) currentBet = 10;
            if(currentBet > balance && balance > 0) currentBet = balance;

            betInput.value = formatNumber(currentBet);
        }

        // --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò –õ–ò–î–ï–†–ë–û–†–î–´ ---
        // –§–µ–π–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –æ–Ω–ª–∞–π–Ω–∞
        const FAKE_USERS = [
            { name: "Melstroy", balance: 50000000, maxWin: 12000000 },
            { name: "Pavel Durov", balance: 10000000, maxWin: 500000 },
            { name: "Elon Musk", balance: 8000000, maxWin: 250000 },
            { name: "Buster", balance: 2500000, maxWin: 150000 },
            { name: "Evelone", balance: 1200000, maxWin: 80000 },
            { name: "Stroi Batya", balance: 500000, maxWin: 25000 },
            { name: "Casino King", balance: 300000, maxWin: 12000 },
            { name: "Lucky Guy", balance: 150000, maxWin: 500000 },
            { name: "Bot_3000", balance: 50000, maxWin: 2000 }
        ];

        function openStats() {
            document.getElementById('statsModal').style.display = 'flex';
            renderLeaderboard();
        }

        function closeStats() {
            document.getElementById('statsModal').style.display = 'none';
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tabBalance').classList.toggle('active', tab === 'balance');
            document.getElementById('tabWins').classList.toggle('active', tab === 'wins');
            renderLeaderboard();
        }

        function renderLeaderboard() {
            // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¢–ï–ö–£–©–ï–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let list = [...FAKE_USERS];
            let me = {
                name: (tg.initDataUnsafe?.user?.first_name || "–¢–´ (YOU)"),
                balance: balance,
                maxWin: maxWin
            };
            list.push(me);

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            if (currentTab === 'balance') {
                list.sort((a, b) => b.balance - a.balance);
            } else {
                list.sort((a, b) => b.maxWin - a.maxWin);
            }

            // –†–µ–Ω–¥–µ—Ä
            let html = '';
            list.forEach((user, index) => {
                let isMe = user === me;
                let rankClass = index === 0 ? 'top-1' : (index === 1 ? 'top-2' : (index === 2 ? 'top-3' : ''));
                let score = currentTab === 'balance' ? user.balance : user.maxWin;
                let scoreClass = currentTab === 'balance' ? 'lb-score gold' : 'lb-score';

                html += `
                    <div class="lb-row ${isMe ? 'is-me' : ''}">
                        <div class="lb-rank ${rankClass}">#${index + 1}</div>
                        <div class="lb-name">${user.name}</div>
                        <div class="${scoreClass}">${formatNumber(score)}</div>
                    </div>
                `;
            });
            lbList.innerHTML = html;
        }


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        function init() {
            createNoiseBuffer();
            reels.forEach(reel => {
                reel.innerHTML = generateStripHTML(20);
                setReelPosition(reel, 10);
            });

            if (tg.CloudStorage) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å
                tg.CloudStorage.getItem('melstroy_balance', (error, value) => {
                    if (!error && value) setBalance(parseInt(value));
                    else loadFromLocal();
                });
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∫–æ—Ä–¥
                tg.CloudStorage.getItem('melstroy_maxwin', (error, value) => {
                    if (!error && value) maxWin = parseInt(value);
                });
            } else {
                loadFromLocal();
            }
            showStatus("–¢–Ø–ù–ò –†–´–ß–ê–ì!", "#fff");
        }

        function loadFromLocal() {
            const localBal = localStorage.getItem('melstroy_balance');
            if (localBal) setBalance(parseInt(localBal));
            else setBalance(1000);

            const localMax = localStorage.getItem('melstroy_maxwin');
            if(localMax) maxWin = parseInt(localMax);
        }

        function setBalance(val) {
            if (isNaN(val) || val < 10) val = 1000;
            balance = val;
            updateUI();
        }

        function saveProgress() {
            localStorage.setItem('melstroy_balance', balance);
            localStorage.setItem('melstroy_maxwin', maxWin);
            if (tg.CloudStorage) {
                tg.CloudStorage.setItem('melstroy_balance', balance.toString());
                tg.CloudStorage.setItem('melstroy_maxwin', maxWin.toString());
            }
        }

        function updateUI() {
            balanceEl.textContent = formatNumber(balance);
        }

        // --- AUDIO HELPERS ---
        function createNoiseBuffer() {
            if(noiseBuffer) return;
            const bufferSize = audioCtx.sampleRate;
            noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;
        }
        function playFilteredNoise(filterFreq, duration, vol) {
            if (!audioCtx) return;
            createNoiseBuffer();
            const noise = audioCtx.createBufferSource();
            noise.buffer = noiseBuffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'bandpass'; filter.frequency.value = filterFreq; filter.Q.value = 5;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            noise.start();
        }
        function playTone(freq, type, duration, vol = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        function playRatchetSound() { playFilteredNoise(2000 + Math.random() * 500, 0.05, 0.3); }
        function playLeverClunk() { playTone(60, 'triangle', 0.2, 0.4); playFilteredNoise(800, 0.1, 0.3); }
        function startSpinSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if(spinInterval) clearInterval(spinInterval);
            let note = 0;
            spinInterval = setInterval(() => {
                playTone(400 + (note % 3) * 100 + Math.random() * 50, 'square', 0.08, 0.05); note++;
            }, 80);
        }
        function stopSpinSound() { if(spinInterval) clearInterval(spinInterval); playTone(800, 'sine', 0.2, 0.1); }
        function playWinSound(amount) {
            [523.25, 659.25, 783.99, 1046.50].forEach((n, i) => setTimeout(() => playTone(n, 'sine', 0.4, 0.1), i * 150));
            if (amount >= 100) for(let k=0; k<10; k++) setTimeout(() => playFilteredNoise(2000+Math.random()*1000, 0.05, 0.1), 600+k*60);
        }

        // --- GAME LOGIC ---
        function generateStripHTML(count) {
            let html = '';
            for(let i=0; i<count; i++) html += `<div class="symbol">${SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]}</div>`;
            return html;
        }
        function setReelPosition(reel, index) {
            reel.style.transform = `translateY(${-(index * SYMBOL_HEIGHT) + 40}px)`;
        }
        function showStatus(text, color='#fff') {
            statusEl.textContent = text; statusEl.style.color = color; statusEl.style.opacity = '1';
            setTimeout(() => { if(!isSpinning) statusEl.style.opacity = '0'; }, 3000);
        }

        // Lever
        let isDragging = false, startY = 0, lastSoundAngle = 0;
        function resetLever() { leverHandle.style.transition = 'transform 0.3s cubic-bezier(0.5, 1.5, 0.5, 1)'; leverHandle.style.transform = 'rotate(0deg)'; setTimeout(() => leverHandle.style.transition = '', 300); }
        function onStart(e) {
            if(isSpinning) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isDragging = true; startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            leverKnob.style.cursor = 'grabbing'; lastSoundAngle = 0;
        }
        function onMove(e) {
            if(!isDragging) return;
            e.preventDefault();
            const currentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const deltaY = currentY - startY;
            let angle = Math.min(Math.max(deltaY * 0.5, 0), 130);
            if (Math.abs(angle - lastSoundAngle) > 15) { playRatchetSound(); lastSoundAngle = angle; }
            leverHandle.style.transform = `rotate(${angle}deg)`;
        }
        function onEnd(e) {
            if(!isDragging) return;
            isDragging = false; leverKnob.style.cursor = 'grab';
            const endY = e.type.includes('touch') ? e.changedTouches[0].clientY : e.clientY;
            if (endY - startY > 150) { playLeverClunk(); setTimeout(startSpin, 250); }
            resetLever();
        }

        leverKnob.addEventListener('mousedown', onStart); document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd);
        leverKnob.addEventListener('touchstart', onStart, {passive: false}); document.addEventListener('touchmove', onMove, {passive: false}); document.addEventListener('touchend', onEnd);

        function startSpin() {
            const betAmount = parseNumber(betInput.value);

            if(balance < betAmount) { showStatus("–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –°–†–ï–î–°–¢–í!", "red"); return; }
            isSpinning = true; balance -= betAmount; saveProgress(); updateUI(); payline.style.display = 'none'; statusEl.style.opacity = '0';
            startSpinSound();

            let finalSymbols = [];
            if (Math.random() < 0.35) {
                const sym = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
                finalSymbols = Math.random() > 0.5 ? [sym, sym, SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]] : [sym, SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)], sym];
            } else {
                for(let i=0; i<3; i++) finalSymbols.push(SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]);
            }

            reels.forEach((reel, i) => {
                const winIndex = 18;
                let stripArr = [];
                for(let k=0; k<20; k++) stripArr.push(SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]);
                stripArr[winIndex] = finalSymbols[i];
                reel.innerHTML = stripArr.map(s => `<div class="symbol ${Math.random()>0.5?'blur':''}">${s}</div>`).join('');
                reel.children[winIndex].classList.remove('blur');

                reel.style.transition = 'none'; reel.style.transform = `translateY(0px)`; reel.offsetHeight;
                reel.style.transition = `transform ${2 + i * 0.5}s cubic-bezier(0.15, 0.1, 0.25, 1)`;
                reel.style.transform = `translateY(${-(winIndex * SYMBOL_HEIGHT) + 40}px)`;
            });

            setTimeout(() => { stopSpinSound(); checkWin(finalSymbols, betAmount); isSpinning = false; }, 3500);
        }

        function checkWin(results, bet) {
            const [s1, s2, s3] = results;
            document.querySelectorAll('.symbol').forEach(el => el.classList.remove('blur'));
            let multiplier = 0;
            if(s1 === s2 && s2 === s3) {
                multiplier = MULTIPLIERS[s1]; showStatus(`–î–ñ–ï–ö–ü–û–¢! x${multiplier}`, '#00ff00'); payline.style.display = 'block';
            } else if (s1 === s2 || s2 === s3 || s1 === s3) {
                 const pair = (s1===s2)?s1:(s2===s3?s2:s1); multiplier = Math.max(1, MULTIPLIERS[pair] * 0.5); showStatus(`–í–´–ò–ì–†–´–®! x${multiplier}`, '#ffd700');
            }

            if(multiplier > 0) {
                const win = Math.floor(bet * multiplier);
                balance += win;
                if(win > maxWin) maxWin = win; // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ—Ä–¥
                saveProgress();
                playWinSound(win);
                setTimeout(() => showStatus(`+${formatNumber(win)}`, '#fff'), 1000);
            } else {
                showStatus("–ü–û–ü–†–û–ë–£–ô –ï–©–ï", "#ccc");
            }
            updateUI();
        }

        init();
    </script>
</body>
</html>
