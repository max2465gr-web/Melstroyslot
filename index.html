<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Melstroy Slot</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap');

        :root {
            --bg-dark: #051e3e;
            --bg-light: #1e5799;
            --neon-blue: #00f2ff;
            --neon-pink: #ff00de;
            --gold-light: #fceabb;
            --gold-dark: #f8b500;
            --gold-shadow: #b06602;
            --red-ball: #d92e2e;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        .star {
            position: absolute;
            color: #ffd700;
            font-size: 20px;
            animation: twinkle 3s infinite ease-in-out;
            opacity: 0.8;
            z-index: 0;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .neon-sign {
            font-size: 36px;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.1;
            text-shadow:
                0 0 5px #fff,
                0 0 10px #fff,
                0 0 20px var(--neon-pink),
                0 0 40px var(--neon-pink);
            z-index: 2;
            position: relative;
        }

        .machine-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(1);
            transition: transform 0.3s;
            z-index: 2;
        }

        .slot-machine {
            width: 340px;
            height: 320px;
            background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold-light) 50%, var(--gold-dark) 100%);
            border-radius: 30px;
            padding: 15px;
            box-shadow:
                inset 0 0 20px rgba(255, 255, 255, 0.5),
                0 20px 50px rgba(0,0,0,0.6),
                0 0 0 5px var(--gold-shadow);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .screen-border {
            width: 100%;
            height: 160px;
            background: #2a1f08;
            border-radius: 15px;
            padding: 8px;
            box-shadow: inset 0 0 15px #000;
            display: flex;
            justify-content: center;
        }

        .reels-container {
            width: 100%;
            height: 100%;
            background: #fff;
            border-radius: 10px;
            display: flex;
            overflow: hidden;
            border: 2px solid #000;
            position: relative;
        }

        .glass-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 50%);
            z-index: 10;
            pointer-events: none;
        }

        .payline {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 0, 0, 0.5);
            transform: translateY(-50%);
            z-index: 5;
            box-shadow: 0 0 10px red;
            display: none;
        }

        .reel {
            flex: 1;
            border-right: 2px solid #ccc;
            position: relative;
        }
        .reel:last-child { border-right: none; }

        .reel-strip {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }

        .symbol {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 45px;
        }

        .blur { filter: blur(3px); }

        .controls-panel {
            margin-top: 15px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .balance-box {
            background: #000;
            border: 2px solid var(--gold-light);
            border-radius: 10px;
            padding: 5px;
            color: #0f0;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.2);
        }

        .bet-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            padding: 5px;
            border: 1px solid var(--gold-shadow);
        }

        .bet-input-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
        }

        .bet-label {
            color: var(--gold-light);
            font-size: 12px;
            font-weight: bold;
        }

        #betInput {
            width: 70px;
            background: #000;
            border: 1px solid var(--gold-light);
            color: #fff;
            padding: 5px;
            border-radius: 5px;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            font-size: 14px;
        }

        .bet-buttons {
            display: flex;
            gap: 3px;
        }

        .bet-btn {
            background: linear-gradient(to bottom, #fceabb, #f8b500);
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 10px;
            font-weight: bold;
            color: #5a3e08;
            cursor: pointer;
            box-shadow: 0 2px 2px rgba(0,0,0,0.3);
        }
        .bet-btn:active { transform: translateY(1px); }

        .lever-container {
            position: absolute;
            right: -30px;
            top: 50px;
            width: 60px;
            height: 200px;
            z-index: 1;
        }

        .lever-handle {
            position: absolute;
            left: 10px;
            top: 110px;
            width: 20px;
            height: 120px;
            transform-origin: bottom center;
            transform: rotate(0deg);
        }

        .lever-stick {
            width: 15px;
            height: 100%;
            background: linear-gradient(90deg, #e6b853, #fff, #b58928);
            border-radius: 10px;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
        }

        .lever-stick::after {
             content: '';
             position: absolute;
             bottom: -10px;
             left: 50%;
             transform: translateX(-50%);
             width: 25px;
             height: 25px;
             background: #b58928;
             border-radius: 50%;
             box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .lever-knob {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, #ff5e5e, var(--red-ball));
            border-radius: 50%;
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: inset -5px -5px 15px rgba(0,0,0,0.3), 5px 10px 15px rgba(0,0,0,0.4);
            cursor: grab;
            z-index: 10;
        }
        .lever-knob:active { cursor: grabbing; }

        #status {
            position: fixed;
            bottom: 20px;
            font-size: 20px;
            color: #fff;
            text-shadow: 0 2px 4px #000;
            z-index: 10;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
        }

        @media (max-width: 450px) {
            .machine-wrapper { transform: scale(0.9); }
            .neon-sign { font-size: 30px; }
        }

    </style>
</head>
<body>

    <div class="star" style="top: 10%; left: 10%;">‚òÖ</div>
    <div class="star" style="top: 20%; right: 15%; animation-delay: 1s;">‚òÖ</div>
    <div class="star" style="top: 80%; left: 20%; animation-delay: 0.5s;">‚òÖ</div>
    <div class="star" style="top: 70%; right: 10%; animation-delay: 1.5s;">‚òÖ</div>

    <div class="neon-sign">MELSTROY<br>SLOT</div>

    <div class="machine-wrapper">
        <div class="slot-machine">
            <div class="screen-border">
                <div class="reels-container">
                    <div class="payline"></div>
                    <div class="glass-overlay"></div>
                    <div class="reel"><div class="reel-strip" id="reel1"></div></div>
                    <div class="reel"><div class="reel-strip" id="reel2"></div></div>
                    <div class="reel"><div class="reel-strip" id="reel3"></div></div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="balance-box">
                    –ë–ê–õ–ê–ù–°: <span id="balance">...</span>
                </div>
                <div class="bet-controls">
                    <div class="bet-input-wrapper">
                        <span class="bet-label">–°–¢–ê–í–ö–ê:</span>
                        <input type="number" id="betInput" value="50" min="10" step="10">
                    </div>
                    <div class="bet-buttons">
                        <button class="bet-btn" onclick="adjustBet('min')">MIN</button>
                        <button class="bet-btn" onclick="adjustBet('half')">/2</button>
                        <button class="bet-btn" onclick="adjustBet('double')">x2</button>
                        <button class="bet-btn" onclick="adjustBet('max')">MAX</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="lever-container">
            <div class="lever-handle" id="leverHandle">
                <div class="lever-stick"></div>
                <div class="lever-knob" id="leverKnob"></div>
            </div>
        </div>
    </div>

    <div id="status">–ó–ê–ì–†–£–ó–ö–ê...</div>

    <script>
        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp ===
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        const SYMBOLS = ['üíé', '7Ô∏è‚É£', 'üîî', 'üçí', 'üçã', 'üí∞'];
        const SYMBOL_HEIGHT = 80;

        const MULTIPLIERS = {
            'üíé': 20,
            '7Ô∏è‚É£': 10,
            'üí∞': 6,
            'üîî': 3,
            'üçã': 1.5,
            'üçí': 0.5
        };

        const reels = [
            document.getElementById('reel1'),
            document.getElementById('reel2'),
            document.getElementById('reel3')
        ];
        const balanceEl = document.getElementById('balance');
        const betInput = document.getElementById('betInput');
        const statusEl = document.getElementById('status');
        const payline = document.querySelector('.payline');
        const leverHandle = document.getElementById('leverHandle');
        const leverKnob = document.getElementById('leverKnob');

        let balance = 1000; // –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        let isSpinning = false;

        // === –ê–£–î–ò–û ===
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let spinInterval = null;
        let noiseBuffer = null;

        // ... (–§—É–Ω–∫—Ü–∏–∏ –∞—É–¥–∏–æ —Ç–µ –∂–µ —Å–∞–º—ã–µ) ...
        function createNoiseBuffer() {
            if(noiseBuffer) return;
            const bufferSize = audioCtx.sampleRate;
            noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
        }
        function playFilteredNoise(filterFreq, duration, vol) {
            if (!audioCtx) return;
            createNoiseBuffer();
            const noise = audioCtx.createBufferSource();
            noise.buffer = noiseBuffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.value = filterFreq;
            filter.Q.value = 5;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start();
        }
        function playTone(freq, type, duration, vol = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }
        function playRatchetSound() {
            const freq = 2000 + Math.random() * 500;
            playFilteredNoise(freq, 0.05, 0.3);
        }
        function playLeverClunk() {
            playTone(60, 'triangle', 0.2, 0.4);
            playFilteredNoise(800, 0.1, 0.3);
        }
        function startSpinSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if(spinInterval) clearInterval(spinInterval);
            let note = 0;
            const baseFreq = 400;
            spinInterval = setInterval(() => {
                const freq = baseFreq + (note % 3) * 100 + Math.random() * 50;
                playTone(freq, 'square', 0.08, 0.05);
                note++;
            }, 80);
        }
        function stopSpinSound() {
            if(spinInterval) clearInterval(spinInterval);
            playTone(800, 'sine', 0.2, 0.1);
        }
        function playWinSound(amount) {
            const notes = [523.25, 659.25, 783.99, 1046.50];
            notes.forEach((note, i) => {
                setTimeout(() => playTone(note, 'sine', 0.4, 0.1), i * 150);
            });
            if (amount >= 100) {
                for(let k=0; k<10; k++) {
                    setTimeout(() => playFilteredNoise(2000 + Math.random()*1000, 0.05, 0.1), 600 + k*60);
                }
            }
        }

        // === –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø ===

        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (Cloud -> Local -> Default)
        function init() {
            createNoiseBuffer();
            reels.forEach(reel => {
                reel.innerHTML = generateStripHTML(20);
                setReelPosition(reel, 10);
            });

            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ CloudStorage (–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
            if (tg.CloudStorage) {
                tg.CloudStorage.getItem('melstroy_balance', (error, value) => {
                    if (!error && value) {
                        setBalance(parseInt(value));
                    } else {
                        // –ï—Å–ª–∏ –≤ –æ–±–ª–∞–∫–µ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º LocalStorage
                        loadFromLocal();
                    }
                    showStatus("–¢–Ø–ù–ò –†–´–ß–ê–ì!", "#fff");
                });
            } else {
                // –ï—Å–ª–∏ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è Telegram –∏–ª–∏ –±—Ä–∞—É–∑–µ—Ä
                loadFromLocal();
                showStatus("–¢–Ø–ù–ò –†–´–ß–ê–ì!", "#fff");
            }
        }

        function loadFromLocal() {
            const localBal = localStorage.getItem('melstroy_balance');
            if (localBal) {
                setBalance(parseInt(localBal));
            } else {
                setBalance(1000); // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
            }
        }

        function setBalance(val) {
            if (isNaN(val) || val < 10) val = 1000; // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞
            balance = val;
            updateUI();
        }

        // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (Cloud + Local)
        function saveBalance() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ LocalStorage (–±—ã—Å—Ç—Ä–æ)
            localStorage.setItem('melstroy_balance', balance);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Telegram CloudStorage (–Ω–∞–¥–µ–∂–Ω–æ)
            if (tg.CloudStorage) {
                tg.CloudStorage.setItem('melstroy_balance', balance.toString(), (err, stored) => {
                    if(err) console.error("Cloud Error", err);
                });
            }
        }

        function updateUI() {
            balanceEl.textContent = balance;
        }

        function adjustBet(action) {
            let currentBet = parseInt(betInput.value) || 10;
            if(action === 'min') currentBet = 10;
            if(action === 'max') currentBet = balance > 0 ? balance : 10;
            if(action === 'double') currentBet *= 2;
            if(action === 'half') currentBet = Math.floor(currentBet / 2);
            if(currentBet < 10) currentBet = 10;
            if(currentBet > balance && balance > 0) currentBet = balance;
            betInput.value = currentBet;
        }

        betInput.addEventListener('change', () => {
            let val = parseInt(betInput.value);
            if(isNaN(val) || val < 10) betInput.value = 10;
            if(val > balance) betInput.value = balance;
        });

        function generateStripHTML(count) {
            let html = '';
            for(let i=0; i<count; i++) {
                const sym = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
                html += `<div class="symbol">${sym}</div>`;
            }
            return html;
        }

        function setReelPosition(reel, index) {
            const y = -(index * SYMBOL_HEIGHT) + 40;
            reel.style.transform = `translateY(${y}px)`;
        }

        function showStatus(text, color='#fff') {
            statusEl.textContent = text;
            statusEl.style.color = color;
            statusEl.style.opacity = '1';
            setTimeout(() => {
                if(!isSpinning) statusEl.style.opacity = '0';
            }, 3000);
        }

        let isDragging = false;
        let startY = 0;
        let lastSoundAngle = 0;

        function resetLever() {
            leverHandle.style.transition = 'transform 0.3s cubic-bezier(0.5, 1.5, 0.5, 1)';
            leverHandle.style.transform = 'rotate(0deg)';
            setTimeout(() => {
                leverHandle.style.transition = '';
            }, 300);
        }

        function onStart(e) {
            if(isSpinning) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isDragging = true;
            startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            leverKnob.style.cursor = 'grabbing';
            lastSoundAngle = 0;
        }

        function onMove(e) {
            if(!isDragging) return;
            e.preventDefault();
            const currentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const deltaY = currentY - startY;
            let angle = deltaY * 0.5;
            if (angle < 0) angle = 0;
            if (angle > 130) angle = 130;

            if (Math.abs(angle - lastSoundAngle) > 15) {
                playRatchetSound();
                lastSoundAngle = angle;
            }
            leverHandle.style.transform = `rotate(${angle}deg)`;
        }

        function onEnd(e) {
            if(!isDragging) return;
            isDragging = false;
            leverKnob.style.cursor = 'grab';
            const endY = e.type.includes('touch') ? e.changedTouches[0].clientY : e.clientY;
            const dist = endY - startY;

            if (dist > 150) {
                playLeverClunk();
                setTimeout(() => startSpin(), 250);
            }
            resetLever();
        }

        leverKnob.addEventListener('mousedown', onStart);
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        leverKnob.addEventListener('touchstart', onStart, {passive: false});
        document.addEventListener('touchmove', onMove, {passive: false});
        document.addEventListener('touchend', onEnd);


        function startSpin() {
            const betAmount = parseInt(betInput.value);

            if(balance < betAmount) {
                showStatus("–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –°–†–ï–î–°–¢–í!", "red");
                return;
            }

            isSpinning = true;
            balance -= betAmount;
            saveBalance(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ —Å—Ç–∞–≤–∫–∏
            updateUI();
            payline.style.display = 'none';
            statusEl.style.opacity = '0';

            startSpinSound();

            let finalSymbols = [];
            const luckyChance = Math.random();

            if (luckyChance < 0.35) {
                const sym = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
                finalSymbols = [sym, sym, SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]];
                if(Math.random() > 0.5) finalSymbols = [sym, SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)], sym];
            } else {
                for(let i=0; i<3; i++) {
                    finalSymbols.push(SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)]);
                }
            }

            reels.forEach((reel, i) => {
                const extraCount = 20 + i * 5;
                const winSymbolIndex = extraCount - 2;

                let stripArr = [];
                for(let k=0; k<extraCount; k++) {
                    stripArr.push(SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]);
                }
                stripArr[winSymbolIndex] = finalSymbols[i];

                reel.innerHTML = stripArr.map(s => `<div class="symbol ${Math.random()>0.5?'blur':''}">${s}</div>`).join('');

                const targetDiv = reel.children[winSymbolIndex];
                targetDiv.classList.remove('blur');
                targetDiv.id = `res-${i}`;

                reel.style.transition = 'none';
                reel.style.transform = `translateY(0px)`;

                reel.offsetHeight;

                const targetY = -(winSymbolIndex * SYMBOL_HEIGHT) + 40;
                const time = 2 + i * 0.5;
                reel.style.transition = `transform ${time}s cubic-bezier(0.15, 0.1, 0.25, 1)`;
                reel.style.transform = `translateY(${targetY}px)`;
            });

            setTimeout(() => {
                stopSpinSound();
                checkWin(finalSymbols, betAmount);
                isSpinning = false;
            }, 3500);
        }

        function checkWin(results, bet) {
            const [s1, s2, s3] = results;
            document.querySelectorAll('.symbol').forEach(el => el.classList.remove('blur'));

            let multiplier = 0;

            if(s1 === s2 && s2 === s3) {
                multiplier = MULTIPLIERS[s1];
                showStatus(`–î–ñ–ï–ö–ü–û–¢! x${multiplier}`, '#00ff00');
                payline.style.display = 'block';
            } else if (s1 === s2 || s2 === s3 || s1 === s3) {
                 const pairSym = (s1 === s2) ? s1 : (s2 === s3 ? s2 : s1);
                 multiplier = Math.max(1, MULTIPLIERS[pairSym] * 0.5);
                 showStatus(`–í–´–ò–ì–†–´–®! x${multiplier}`, '#ffd700');
            }

            if(multiplier > 0) {
                const winAmount = Math.floor(bet * multiplier);
                balance += winAmount;
                saveBalance(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –≤—ã–∏–≥—Ä—ã—à–∞
                playWinSound(winAmount);
                setTimeout(() => showStatus(`+${winAmount}`, '#fff'), 1000);
            } else {
                showStatus("–ü–û–ü–†–û–ë–£–ô –ï–©–ï", "#ccc");
            }

            updateUI();
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>
